
name: Provision three tier architecture using terraform

on:
  workflow_dispatch:
  push:
      branches: [main]

jobs:
  
  provision-three-tier:
    runs-on: ubuntu-latest
    env:
      PKR_VAR_region: us-east-1
      PKR_VAR_instance_type: t2.micro
      TF_VAR_key_pair: ${{ secrets.ssh_private_key }}
      AWS_ACCESS_KEY_ID: ${{ secrets.aws_access_key }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.aws_secret_access_key }}
      TF_VAR_db_user_name : ${{ secrets.db_user_name }}
      TF_VAR_db_password : ${{ secrets.db_password }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: set up packer
        id: setup 
        uses: hashicorp/setup-packer@main

      
      - name: initialize packer
        id: initpacker
        run: "packer-init ./image-builder/" 

      - name: format packer
        id: fmtpacker
        run: "packer fmt ./image-builder/" 

      - name: validate packer
        id: validate
        run: "packer validate ./image-builder/" 

      - name: build image 
        id: build 
        run: "packer build ./image-builder/" 

      - name: set up terraform 
        uses: hashicorp/setup-terraform@v2
        id: setupterraform

      - name: terraform init 
        id: initializeterraform
        run: terraform init 

      - name: format terraform
        id: formatterraform
        run: terraform fmt

      - name: validate terraform
        id: validateterraform
        run: terraform validate

      - name: terraform plan
        id: plan
        run: terraform plan -input=false 

      - name: terraform apply
        id: apply 
        run: terraform apply --auto-approve

      

      